apiVersion: batch/v1
kind: CronJob
metadata:
  name: unixpense-cron
  namespace: unixpense
spec:
  schedule: "$CRONTAB"
  successfulJobsHistoryLimit: 0
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 5
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: mariadb-client
            image: mariadb:latest
            env:
            - name: MARIADB_USER
              valueFrom:
                secretKeyRef:
                  name: mariadb-secret
                  key: MARIADB_USER
            - name: MARIADB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-secret
                  key: MARIADB_PASSWORD
            command:
            - /bin/sh
            - -ec
            - |
              apt-get -qy update; apt-get -qy -o=Dpkg::Use-Pty=0 install curl

              ACCESS_TOKEN_QUERY="\
                SELECT access_token
                FROM google_oauth2_tokens
                WHERE user_email='$GMAIL_ADDRESS'"

              echo -n Resolving OAuth2 Access Token...

              ACCESS_TOKEN=$(mariadb unixpense \
                -h mariadb-service.unixpense.svc.cluster.local \
                -u$MARIADB_USER \
                -p$MARIADB_PASSWORD \
                -se "$ACCESS_TOKEN_QUERY")

              echo $ACCESS_TOKEN

              echo -n Fetching new transaction IDs...

              TRANSACTION_IDS=$(curl -s \
                -X GET "http://unixpense-svc-service.unixpense.svc.cluster.local:8000/api/transactions/gmail/ids/last/20?skip_saved=true&skip_depth=10" \
                -H "X-User-Email: $GMAIL_ADDRESS" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "Accept: application/json")

              echo $TRANSACTION_IDS

              echo -n Saving new transaction IDs...

              RESULT=$(curl -s \
                -X POST "http://unixpense-svc-service.unixpense.svc.cluster.local:8000/api/transactions/gmail/save" \
                -H "X-User-Email: $GMAIL_ADDRESS" \
                -H "Authorization: Bearer $ACCESS_TOKEN" \
                -H "Accept: application/json" \
                -H "Content-Type: application/json" \
                -d $TRANSACTION_IDS)

              echo Response: $RESULT